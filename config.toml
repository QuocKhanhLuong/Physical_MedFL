# Unified Federated Learning Configuration
# Complete configuration with multiple performance levels
# Choose your configuration by uncommenting the desired federation

# =====================================================
# BASIC CONFIGURATION (Stable, Conservative)
# =====================================================

[tool.flwr.app.config]
# Server Configuration - OPTIMIZED TO MATCH CENTRALIZED PERFORMANCE (91.75% Dice)
num-rounds = 3                           # REDUCED for quick testing
round-timeout = 3600                     # 1 hour timeout for complex training
strategy = "FedAdam"                     # Using STANDARD FedAdam with medical optimization

# FedAdam Strategy Parameters (TUNED for HIGH PERFORMANCE medical imaging)
eta = 0.05                               # REDUCED server LR for stable convergence with 5 local epochs
eta-l = 0.003                            # REDUCED client LR to match centralized training
beta-1 = 0.9                             # Standard momentum for stable training
beta-2 = 0.999                           # Standard second moment
tau = 1e-7                               # SMALLER tau for better numerical precision

# FedAvg Strategy Parameters (for comparison testing)
# Uncomment and change strategy to "FedAvg" to test if issue is FedAdam-specific
# fedavg-learning-rate = 1.0              # FedAvg server learning rate
# fedavg-client-learning-rate = 0.01      # FedAvg client learning rate

# Client Selection - OPTIMIZED
fraction-fit = 1.0
fraction-evaluate = 1.0
min-fit-clients = 2                      # Use both clients
min-evaluate-clients = 2

# Medical Domain Adaptations - ENABLED FOR HIGH PERFORMANCE
noise-adaptation = true                  # ENABLED - helps with robustness
physics-scheduling = true                # ENABLED - physics constraints improve segmentation
progressive-complexity = true            # ENABLED - gradual complexity increase

# Training Configuration - OPTIMIZED FOR HIGH PERFORMANCE
local-epochs = 5                         # MATCHED to achieve centralized-level learning
batch-size = 4                           # INCREASED for better gradient estimates
test-batch-size = 4                      # INCREASED for consistent evaluation
weight-decay = 1e-6                      # REDUCED for less aggressive regularization

# Data Configuration
num-classes = 4
img-size = 256
enable-global-evaluation = true          # ENABLED for better monitoring

# =====================================================
# üçé MAC GPU OPTIMIZED CONFIGURATION 
# =====================================================

[tool.flwr.app.client.config.mac-gpu]
# Client Training Settings - OPTIMIZED FOR 99.4% ACCURACY
local_epochs = 5
batch_size = 4                           # REDUCED for better gradient quality
learning_rate = 0.003                    # INCREASED to match server eta-l
weight_decay = 1e-6                      # REDUCED regularization
gradient_clipping = 2.0                  # INCREASED for stability

# GPU-specific optimizations
mixed_precision = false
memory_efficient = true

# Medical imaging specific
augmentation_probability = 0.7
noise_injection_std = 0.0

[tool.flwr.app.client.data.mac-gpu]
# Data settings optimized for GPU memory
target_image_size = [256, 256]
cache_data_in_memory = true        # GPU has good memory bandwidth
num_workers = 2                    # Parallel data loading
prefetch_factor = 2

# =====================================================
# üöÄ HIGH PERFORMANCE CONFIGURATION
# =====================================================

[tool.flwr.app.config.high-performance]
# High Performance Server Settings - OPTIMIZED FOR 99.4% ACCURACY
num-rounds = 40
eta = 0.03                               # INCREASED to match main config
eta-l = 0.003                            # INCREASED to match main config
beta-1 = 0.9
beta-2 = 0.99
tau = 1e-9
min-fit-clients = 3                      # REDUCED for faster training
min-evaluate-clients = 2

# Advanced features - DISABLED FOR BEST RESULTS
noise-adaptation = false
physics-scheduling = false               # DISABLED (physics_loss = 0.0 in good results)
progressive-complexity = false           # DISABLED for stability

[tool.flwr.app.client.config.high-performance]
# High Performance Client Settings - OPTIMIZED FOR 99.4% ACCURACY
local_epochs = 3
batch_size = 4
learning_rate = 0.003                    # INCREASED to match server eta-l
weight_decay = 1e-6                      # REDUCED regularization
gradient_clipping = 2.0                  # INCREASED for stability

# Advanced optimizations
mixed_precision = false
memory_efficient = true
gradient_accumulation_steps = 2

# Medical imaging specific
augmentation_probability = 0.7
noise_injection_std = 0.0
class_weight_rebalancing = true

[tool.flwr.app.client.data.high-performance]
# High Performance Data Settings
target_image_size = [256, 256]
cache_data_in_memory = true
num_workers = 3                    # Maximum parallel loading
prefetch_factor = 3
data_augmentation_intensity = "moderate"  # REDUCED from high to moderate

# =====================================================
# üìä MONITORING & LOGGING
# =====================================================

[monitoring]
track_gpu_memory = true
log_performance_metrics = true
benchmark_mode = false
detailed_metrics = true
save_model_checkpoints = true
convergence_tracking = true

# =====================================================
# üéõÔ∏è STRATEGY TUNING (ADVANCED)
# =====================================================

[strategy.basic]
eta = 0.001
eta_l = 0.0001
beta_1 = 0.9
beta_2 = 0.99
tau = 1e-9
min_fit_clients = 1
min_evaluate_clients = 1

[strategy.mac-gpu]
eta = 0.01
eta_l = 0.0005
beta_1 = 0.9
beta_2 = 0.99
tau = 1e-9
min_fit_clients = 3
min_evaluate_clients = 2

[strategy.high-performance]
eta = 0.015
eta_l = 0.0007
beta_1 = 0.9
beta_2 = 0.99
tau = 1e-9
min_fit_clients = 5
min_evaluate_clients = 3

# =====================================================
# üè• MEDICAL SEGMENTATION OPTIMIZATION
# =====================================================

[medical.basic]
class_weights = [0.1, 1.5, 2.0, 1.8]    # Conservative rebalancing
dice_loss_weight = 0.5
ce_loss_weight = 0.5
focus_on_rare_classes = false

[medical.enhanced]
class_weights = [0.05, 3.0, 2.5, 2.8]   # Aggressive rebalancing 
dice_loss_weight = 0.6
ce_loss_weight = 0.4
focus_on_rare_classes = true

[medical.extreme]
class_weights = [0.05, 3.5, 3.0, 3.2]   # Maximum rebalancing for ACDC
dice_loss_weight = 0.7
ce_loss_weight = 0.3
focus_on_rare_classes = true

# =====================================================
# üéØ FEDERATION CONFIGURATIONS
# =====================================================

[tool.flwr.federations]
default = "high-performance-simulation"  # üöÄ USING HIGH PERFORMANCE CONFIGURATION BY DEFAULT

# 1Ô∏è‚É£ BASIC CONFIGURATION (2 clients, conservative)
[tool.flwr.federations.basic-simulation]
options.num-supernodes = 2
options.backend.client-resources.num-cpus = 2
options.backend.client-resources.num-gpus = 0.5

# 2Ô∏è‚É£ MAC GPU CONFIGURATION (5 clients, GPU optimized)
[tool.flwr.federations.mac-gpu-simulation]
options.num-supernodes = 5
options.backend.client-resources.num-cpus = 2
options.backend.client-resources.num-gpus = 0.2

# 3Ô∏è‚É£ HIGH PERFORMANCE CONFIGURATION (7 clients, maximum performance)
[tool.flwr.federations.high-performance-simulation]
options.num-supernodes = 7
options.backend.client-resources.num-cpus = 2
options.backend.client-resources.num-gpus = 0.15

# 4Ô∏è‚É£ EXTREME PERFORMANCE (10 clients, for powerful systems)
[tool.flwr.federations.extreme-simulation]
options.num-supernodes = 10
options.backend.client-resources.num-cpus = 2
options.backend.client-resources.num-gpus = 0.1

# =====================================================
# üìù CONFIGURATION SWITCHING INSTRUCTIONS
# =====================================================

# TO SWITCH CONFIGURATIONS:
# 1. Change the "default" value in [tool.flwr.federations] section:
#    - "basic-simulation": 2 clients, 15 rounds, conservative
#    - "mac-gpu-simulation": 5 clients, 30 rounds, GPU optimized
#    - "high-performance-simulation": 7 clients, 40 rounds, maximum performance
#    - "extreme-simulation": 10 clients, 50 rounds, extreme performance
#
# 2. Run with: flwr run . --run-config config.toml
#
# EXAMPLES:
# Basic (stable):           default = "basic-simulation"
# Mac GPU (balanced):       default = "mac-gpu-simulation"  
# High Performance:         default = "high-performance-simulation"
# Extreme (experimental):   default = "extreme-simulation" 